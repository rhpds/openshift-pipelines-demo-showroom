= Module 3: Multi-Environment & Production Confidence
:imagesdir: ../assets/images
:source-highlighter: rouge

In this module, you'll demonstrate how OpenShift Pipelines enables safe, repeatable promotions across dev → staging → production environments with approval gates, solving HealthTech's regional fragmentation challenges and production deployment risks.

== Part 1: Multi-Environment Pipeline Promotion

=== Know

_HealthTech operates 11 regional data centers across the United States and Canada to meet healthcare data residency requirements. Manual deployments to each region take 6-8 weeks total (sequential process), and configuration inconsistencies cause environment-specific bugs that delay production rollouts._

**Current Multi-Environment Challenges**:

**Regional Fragmentation**:

* 11 regional data centers with slightly different configurations
* Manual deployments introduce configuration drift between environments
* Each region deployed sequentially (not parallel), consuming 6-8 weeks total
* Environment-specific bugs discovered only in production

**Production Deployment Risks**:

* No standardized promotion process from dev → staging → production
* Production deployments happen during business hours, risking patient care interruptions
* Manual rollback procedures are error-prone (average: 4 hours downtime per incident)
* Cannot confidently deploy during low-traffic windows

**Business Impact**:

* 3 production incidents in the past quarter caused by deployment failures
* Customer SLAs at risk: 99.9% uptime commitment, currently achieving 99.3%
* 50,000 active users affected by 4-hour patient portal outage
* Regional feature delivery inconsistency creates customer confusion

**Example Incident**:

HealthTech deployed a prescription management update to the East Coast region during business hours. A configuration error (hardcoded database connection string) caused the deployment to fail, taking the patient portal offline for 4 hours. The incident violated customer SLAs and triggered a compliance review. The same deployment had worked perfectly in the dev and staging environments because those environments used different database configurations.

**What Multi-Environment Pipelines Solve**:

**Consistent Promotion Workflow**:

* Same container image promoted from dev → staging → production (no rebuilding)
* Environment-specific configuration externalized (ConfigMaps, Secrets)
* Automated testing at each stage ensures production readiness
* Approval gates enforce governance without manual bottlenecks

**Benefits**:

* Configuration consistency eliminates environment-specific bugs
* Parallel regional deployments reduce 6-8 weeks to days
* Automated rollback reduces downtime from 4 hours to seconds
* Zero-downtime deployments via blue-green or canary strategies

=== Show

**Optional visual**: Architecture diagram showing dev → staging → production promotion with approval gates and environment-specific configuration

**What I say**:

"HealthTech's manual regional deployments take 6-8 weeks and cause production incidents due to configuration inconsistencies. Let me show you how OpenShift Pipelines promotes applications safely across environments using the same tested container image with environment-specific configuration."

**What I do**:

. Create environment projects in OpenShift

* In the OpenShift web console, create three projects (namespaces):
+
[source,bash]
----
oc new-project healthtech-dev
oc new-project healthtech-staging
oc new-project healthtech-production
----

* Explain: "These projects represent HealthTech's dev, staging, and production environments. In a real deployment, these could be separate clusters in different regions."

. Demonstrate the promotion workflow

* Navigate to "Pipelines" view
* Explain the multi-environment promotion strategy:
+
[source,text]
----
1. Build container image in DEV environment (healthtech-dev)
2. Run automated tests in DEV
3. Promote image to STAGING (healthtech-staging) - no rebuild
4. Run integration tests in STAGING
5. [Approval Gate] - Wait for authorized approver
6. Promote image to PRODUCTION (healthtech-production)
7. Monitor production deployment for issues
8. [Optional] Automated rollback if health checks fail
----

. Create a multi-environment pipeline

* Click "Pipelines" → "Create" → "Pipeline"
* Name: `healthtech-multi-env-promotion`
* Add Tasks in sequence:

**Task 1: Build and Test in Dev**

[source,yaml]
----
- name: build-dev
  taskRef:
    name: buildah
  params:
    - name: IMAGE
      value: image-registry.openshift-image-registry.svc:5000/healthtech-dev/patient-portal:$(params.VERSION)
----

**Task 2: Deploy to Dev**

[source,yaml]
----
- name: deploy-dev
  taskRef:
    name: openshift-client
  params:
    - name: SCRIPT
      value: |
        oc apply -f deployment-dev.yaml -n healthtech-dev
        oc rollout status deployment/patient-portal -n healthtech-dev
----

**Task 3: Promote to Staging**

[source,yaml]
----
- name: promote-staging
  taskRef:
    name: skopeo-copy
  params:
    - name: srcImageURL
      value: image-registry.openshift-image-registry.svc:5000/healthtech-dev/patient-portal:$(params.VERSION)
    - name: destImageURL
      value: image-registry.openshift-image-registry.svc:5000/healthtech-staging/patient-portal:$(params.VERSION)
----

**Task 4: Deploy to Staging**

[source,yaml]
----
- name: deploy-staging
  taskRef:
    name: openshift-client
  params:
    - name: SCRIPT
      value: |
        oc apply -f deployment-staging.yaml -n healthtech-staging
        oc rollout status deployment/patient-portal -n healthtech-staging
----

**Task 5: Manual Approval Gate (Production)**

* Explain: "At this point, the pipeline pauses for manual approval before production deployment."
* Add a manual approval Task or integrate with ServiceNow/Jira

**Task 6: Promote to Production**

[source,yaml]
----
- name: promote-production
  taskRef:
    name: skopeo-copy
  params:
    - name: srcImageURL
      value: image-registry.openshift-image-registry.svc:5000/healthtech-staging/patient-portal:$(params.VERSION)
    - name: destImageURL
      value: image-registry.openshift-image-registry.svc:5000/healthtech-production/patient-portal:$(params.VERSION)
----

**Task 7: Blue-Green Deployment to Production**

[source,yaml]
----
- name: deploy-production-blue-green
  taskRef:
    name: openshift-client
  params:
    - name: SCRIPT
      value: |
        # Deploy new version (green) alongside existing version (blue)
        oc apply -f deployment-production-green.yaml -n healthtech-production
        oc rollout status deployment/patient-portal-green -n healthtech-production

        # Run health checks on green deployment
        ./health-check.sh patient-portal-green

        # If health checks pass, switch traffic to green
        oc patch service patient-portal -n healthtech-production -p '{"spec":{"selector":{"version":"green"}}}'

        # Monitor for 5 minutes
        sleep 300

        # If no issues, delete blue deployment
        oc delete deployment patient-portal-blue -n healthtech-production
----

. Show environment-specific configuration

* Explain: "HealthTech uses ConfigMaps and Secrets for environment-specific configuration (database URLs, API endpoints, credentials). The same container image runs in all environments with different configuration."

* Show example ConfigMap for each environment:

**Dev ConfigMap**:

[source,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: patient-portal-config
  namespace: healthtech-dev
data:
  DATABASE_URL: "postgresql://dev-db.healthtech.internal:5432/dev"
  API_ENDPOINT: "https://api-dev.healthtech.com"
  LOG_LEVEL: "DEBUG"
----

**Production ConfigMap**:

[source,yaml]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: patient-portal-config
  namespace: healthtech-production
data:
  DATABASE_URL: "postgresql://prod-db.healthtech.internal:5432/production"
  API_ENDPOINT: "https://api.healthtech.com"
  LOG_LEVEL: "INFO"
----

. Demonstrate the promotion workflow

* Start the multi-environment pipeline
* Watch as it builds in dev, promotes to staging, waits for approval, then promotes to production
* Highlight the approval gate pause point
* Show how the same container image is used in all environments (no rebuilding)

**What they should notice**:

* ✓ Same container image promoted across environments (no rebuild = no risk)
* ✓ Environment-specific configuration externalized (eliminates configuration drift)
* ✓ Approval gates enforce governance at production boundary
* ✓ Blue-green deployment eliminates downtime during production rollout
* ✓ **Metric highlight**: "HealthTech's 6-8 week sequential regional deployments now run in parallel, completing in 2-3 days across all 11 regions."

**Optional visual**: Screenshot of multi-environment pipeline showing dev → staging → production promotion with approval gate

**If asked**:

Q: "How do we handle database schema migrations across environments?"

A: "OpenShift Pipelines can orchestrate database migrations as part of the promotion workflow:

. Run migration scripts in dev environment during deployment
. Validate schema changes with automated tests
. Promote application + migration scripts to staging
. Run migrations in staging, validate with integration tests
. [Approval Gate] Review migration success before production
. Run migrations in production as a separate Task before application deployment
. If migration fails, pipeline halts before deploying new application version

For zero-downtime migrations, use backward-compatible schema changes (add column, deploy code, remove old column in next release)."

Q: "What if we need to roll back a production deployment?"

A: "OpenShift provides multiple rollback mechanisms:

* **Automatic Rollback**: If health checks fail post-deployment, OpenShift reverts to previous version
* **Manual Rollback via CLI**: `oc rollout undo deployment/patient-portal`
* **Blue-Green Rollback**: Keep blue (old) deployment running, switch traffic back if green (new) has issues
* **Pipeline-Based Rollback**: Trigger a pipeline run with the previous version tag

All rollback actions are logged in the audit trail for compliance."

Q: "Can we deploy to multiple regions in parallel instead of sequentially?"

A: "Yes. OpenShift Pipelines supports parallel Task execution:

[source,yaml]
----
tasks:
  - name: deploy-us-east
    taskRef:
      name: deploy-to-cluster
    params:
      - name: CLUSTER
        value: us-east

  - name: deploy-us-west
    taskRef:
      name: deploy-to-cluster
    params:
      - name: CLUSTER
        value: us-west

  - name: deploy-canada
    taskRef:
      name: deploy-to-cluster
    params:
      - name: CLUSTER
        value: canada

# These Tasks run in parallel, not sequentially
----

HealthTech can deploy to all 11 regions simultaneously, completing in hours instead of weeks."

== Part 2: Production Confidence and Automated Rollback

=== Know

_Beyond promoting applications across environments, HealthTech needs confidence that production deployments will succeed without causing outages. Traditional deployment strategies (replace existing version) create risk. Advanced deployment strategies (blue-green, canary) minimize risk but require orchestration._

**Production Deployment Challenges**:

* Traditional deployments cause downtime during rollout
* No validation of new version before switching production traffic
* Manual rollback procedures take hours and are error-prone
* Production incidents affect thousands of users simultaneously

**Advanced Deployment Strategies**:

**Blue-Green Deployment**:

* Deploy new version (green) alongside existing version (blue)
* Validate green deployment with health checks and smoke tests
* Switch production traffic from blue to green
* Keep blue deployment running for quick rollback if needed
* Delete blue after green proves stable

**Canary Deployment**:

* Deploy new version to small subset of users (5-10%)
* Monitor metrics (error rates, latency, business KPIs)
* Gradually increase traffic to new version (25%, 50%, 100%)
* Automatically rollback if metrics degrade
* Full rollout only after canary validates new version

**Benefits**:

* Zero-downtime deployments (users never experience outage)
* Automated validation before full production traffic
* Quick rollback (seconds instead of hours)
* Risk mitigation through gradual rollout

=== Show

**What I say**:

"HealthTech's production incidents caused 4-hour outages affecting 50,000 users. Let me show you how advanced deployment strategies eliminate downtime and provide automatic rollback if issues occur."

**What I do**:

. Demonstrate blue-green deployment strategy

* Explain the blue-green approach:
+
[source,text]
----
Current production (blue):
  - patient-portal-blue deployment running
  - Service routes traffic to blue version
  - 100% of production traffic

New deployment (green):
  - Deploy patient-portal-green alongside blue
  - Run health checks on green
  - If healthy, switch service to route traffic to green
  - Blue remains running for quick rollback
  - Delete blue after validation period (e.g., 24 hours)
----

. Show the blue-green deployment YAML

[source,yaml]
----
---
# Blue deployment (current production)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: patient-portal-blue
  namespace: healthtech-production
spec:
  replicas: 3
  selector:
    matchLabels:
      app: patient-portal
      version: blue
  template:
    metadata:
      labels:
        app: patient-portal
        version: blue
    spec:
      containers:
      - name: patient-portal
        image: image-registry.openshift-image-registry.svc:5000/healthtech-production/patient-portal:v1.2.0

---
# Green deployment (new version)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: patient-portal-green
  namespace: healthtech-production
spec:
  replicas: 3
  selector:
    matchLabels:
      app: patient-portal
      version: green
  template:
    metadata:
      labels:
        app: patient-portal
        version: green
    spec:
      containers:
      - name: patient-portal
        image: image-registry.openshift-image-registry.svc:5000/healthtech-production/patient-portal:v1.3.0

---
# Service (controls traffic routing)
apiVersion: v1
kind: Service
metadata:
  name: patient-portal
  namespace: healthtech-production
spec:
  selector:
    app: patient-portal
    version: blue  # Initially routes to blue, then switch to green
  ports:
  - port: 8080
    targetPort: 8080
----

. Demonstrate the traffic switch

* Show how to switch traffic from blue to green:
+
[source,bash]
----
# Switch traffic to green deployment
oc patch service patient-portal -n healthtech-production \
  -p '{"spec":{"selector":{"version":"green"}}}'

# Verify traffic is routed to green
oc get service patient-portal -n healthtech-production -o yaml | grep version
----

. Show automated rollback

* Explain the rollback scenario:
+
[source,bash]
----
# If green deployment has issues, immediately switch back to blue
oc patch service patient-portal -n healthtech-production \
  -p '{"spec":{"selector":{"version":"blue"}}}'

# Rollback completes in seconds (blue was still running)
# No need to redeploy or wait for pods to start
----

. Demonstrate canary deployment (optional, if time permits)

* Explain the canary approach using OpenShift Routes with traffic splitting:
+
[source,yaml]
----
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: patient-portal-canary
  namespace: healthtech-production
spec:
  to:
    kind: Service
    name: patient-portal-stable
    weight: 90  # 90% of traffic to stable version
  alternateBackends:
  - kind: Service
    name: patient-portal-canary
    weight: 10  # 10% of traffic to canary version
----

* Explain: "HealthTech can gradually increase canary traffic (10% → 25% → 50% → 100%) while monitoring metrics. If error rates spike, automatically route 100% back to stable version."

. Show production monitoring and validation

* Navigate to "Observe" → "Metrics" in OpenShift console
* Show example metrics to monitor during production deployment:
  * HTTP request rate
  * Error rate (5xx responses)
  * Response latency (p50, p95, p99)
  * Application-specific metrics (prescription submission rate)

* Explain: "Automated monitoring during canary deployments allows the pipeline to detect issues and rollback before all users are affected."

**What they should notice**:

* ✓ Zero-downtime deployment (blue and green run simultaneously)
* ✓ Automated validation before switching production traffic
* ✓ Instant rollback capability (switch service selector)
* ✓ Risk mitigation through canary deployments (gradual rollout)
* ✓ **Metric highlight**: "HealthTech's production rollback time drops from 4 hours (manual redeployment) to 15 seconds (automated service switch)."

**Optional visual**: Diagram showing blue-green deployment flow with traffic switch and rollback scenarios

**If asked**:

Q: "How do we monitor application health during blue-green deployments?"

A: "OpenShift provides multiple health check mechanisms:

* **Liveness Probes**: Restart pod if application becomes unresponsive
* **Readiness Probes**: Remove pod from service traffic if not ready
* **Startup Probes**: Allow slow-starting applications time to initialize

Combined with application-specific health endpoints (`/health`, `/ready`), these probes ensure only healthy pods receive traffic. During blue-green deployment, green pods must pass readiness checks before the service routes traffic to them."

Q: "Can we automate the decision to rollback based on metrics?"

A: "Yes, using progressive delivery tools like Argo Rollouts or Flagger:

* Define success metrics (error rate < 1%, latency < 200ms)
* Deploy canary version
* Monitor metrics for defined period (e.g., 10 minutes)
* If metrics degrade beyond threshold, automatically rollback
* If metrics are healthy, progressively increase canary traffic

This fully automated approach eliminates manual monitoring during deployments."

Q: "What about database state during rollbacks? If we rollback the application, does the database rollback too?"

A: "Database rollbacks are more complex than application rollbacks. Best practices:

* **Forward-Only Migrations**: Make database changes backward-compatible (new application can run on old schema, old application can run on new schema)
* **Feature Flags**: Use feature flags to enable/disable new functionality without redeploying
* **Two-Phase Deployment**:
  1. Deploy schema change (backward-compatible)
  2. Deploy application change (uses new schema)
  3. If rollback needed, only application rolls back (schema remains)

For critical rollbacks requiring database changes, maintain database backup and restoration procedures separate from application deployment pipelines."

== Summary

In this module, you demonstrated how OpenShift Pipelines enables safe multi-environment promotion and production confidence for HealthTech's complex regional deployment requirements:

**What You Demonstrated**:

* Multi-environment promotion (dev → staging → production) with same container image
* Environment-specific configuration externalized (ConfigMaps, Secrets)
* Approval gates for production deployments
* Blue-green deployment strategy for zero-downtime rollouts
* Automated rollback capabilities
* Parallel regional deployments (11 regions simultaneously)

**Business Value Delivered**:

* **6-8 weeks → 2-3 days regional deployments**: Parallel deployment vs sequential
* **Zero production downtime**: Blue-green deployments eliminate outages
* **4 hours → 15 seconds rollback time**: Automated rollback vs manual redeployment
* **99.3% → 99.95% uptime**: Meet customer SLA commitments
* **Eliminated environment-specific bugs**: Same image + externalized config = consistency

**Key "Wow Moments" Recap**:

* Same container image promoted across all environments (no rebuild risk)
* Approval gate pauses pipeline for governance without blocking automation
* Blue-green deployment runs new and old versions simultaneously for instant rollback
* 11 regional deployments complete in parallel (days instead of weeks)

**Complete Demo Recap**:

Across all three modules, you've shown how OpenShift Pipelines transforms HealthTech's deployment process:

* **Module 1**: 3 weeks → 2 hours automated deployment, 5x feature velocity
* **Module 2**: 90% fewer vulnerabilities, 89% less audit preparation time
* **Module 3**: Zero downtime deployments, 15-second rollback, 99.95% uptime

**Total Business Impact**:

* **Time Savings**: 97% faster deployments
* **Quality**: 90% fewer security vulnerabilities
* **Compliance**: 89% reduction in audit preparation time
* **Reliability**: 99.95% uptime (vs 99.3% before)
* **Scale**: 11 regional data centers deployed consistently
* **Developer Productivity**: 40% less wait time, 20+ hours saved per deployment

**Next Steps**:

Proceed to the xref:06-conclusion.adoc[Conclusion] module for business impact recap, competitive advantages summary, next steps for evaluation and pilot programs, and comprehensive references.
